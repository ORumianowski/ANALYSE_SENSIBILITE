---
title: "Analyse sensibilité"
author: "RUMIANOWSKI 0."
output: 
  html_document:
    theme: simplex
date: "2023-09-11"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
library(tidyverse)
library(ggpubr)
library(sensitivity)

source(file = "functionModProjet2023.r")
```


### Question 1

#### 1.A. Définissez le type de ce modèle
  
   Le modèle est :
  - **déterministe** puisque les résultats qu'il produit sont entièrement déterminés par les paramètres initiaux et les équations le décrivant, sans aucune composante aléatoire,
  - **à compartiment**, les individus sont groupés selon leur état de santé et leur classe d'âge,
  - **à un temps discret** car le temps (2 ans) est divisé en 730 jours au cours desquels les changements d'états du système ont lieux. 
  
 #### 1.B. Quels sont les processus biologiques en jeu ?
  
  Le grand processus biologique modélisé est une **épidémie**.
  
  Dans ce modèle, les individus sont groupés en quatre catégories selon le stade épidémique:  
  
  1- Les individus susceptibles, notés S. Ils sont susceptibles de se faire infecter. 
  
  2- Les individus exposés (infectés/non-infectieux), notés E ou L. Ils sont dans un état latent dans lequel ils sont infectés mais pas encore contagieux.
  
  3- Les individus infectés/infectieux, notés I. Ils sont infectés et contagieux. Cette classe a un risque de mortalité additionnel lié à la maladie.
  
  4- Les individus rétablis/non-sensible, notés R. Ils ne sont plus contagieux ni susceptibles d'être infectés. Ils peuvent malgré tout perdre leur immunité et redevenir susceptibles. 
  
  Ce modèle est donc un modèle SEIRS/SLIRS (Susceptible-Exposé/Latent-Infecté-Retiré-Susceptible). Les processus biologiques représentés à travers ce modèle correspondent aux transitions entre les états et sont la **transmission** de la maladie, le temps de **latence** entre l'exposition et l'état infectieux, la **mortalité due à la maladie** ou la **récupération/immunisation** après la maladie, et la **perte d'immunité**. A ces processus liés à la maladie s'ajoute des processus démographiques : **natalité** et **mortalité naturelle** (hors maladie). 
  
  En plus des états de santé, la population est structuré en classe d'âge ayant un taux de mortalité et de fertilité propre. 

  
#### 1.C. Ecrivez les équations associées
  
 Pour la classe d'âge 1 (enfant)
  $$\left\{ 
  \begin{array}{ll}
  S_{1}(t+1)= S_{1}(t).(1-m_{1}-t_{1}-\beta.\frac{\sum_{i=1}^{3}{I_{i}(t)}}{N(t)})+\xi.R_{1}(t)+SR.P.(N_{2}(t).f_{2}+N_{3}(t).f_{3}).(1-\frac{N}{K}) \\
   E_{1}(t+1)= E_{1}(t).(1-m_{1}-t_{1}-\sigma)+S_{1}(t).\beta.\frac{\sum_{i=1}^{3}{I_{i}(t)}}{N(t)} \\
    I_{1}(t+1)= I_{1}(t).(1-m_{1}-t_{1}-\mu-\gamma)+E_{1}(t).\sigma \\
     R_{1}(t+1)= R_{1}(t).(1-m_{1}-t_{1}-\xi)+I_{1}(t).\gamma
   \end{array}
  \right.$$
  Pour la classe d'âge 2 (adulte)
  $$\left\{ 
  \begin{array}{ll}
  S_{2}(t+1)= S_{1}(t).t_{1} + S_{2}(t).(1-m_{2}-t_{2}-\beta.\frac{\sum_{i=1}^{3}{I_{i}(t)}}{N(t)})+\xi.R_{2}(t) \\
   E_{2}(t+1)= E_{1}(t).t_{1} + E_{2}(t).(1-m_{2}-t_{2}-\sigma)+S_{2}(t).\beta.\frac{\sum_{i=1}^{3}{I_{i}(t)}}{N(t)} \\
    I_{2}(t+1)= I_{1}(t).t_{1} + I_{2}(t).(1-m_{2}-t_{2}-\mu-\gamma)+E_{2}(t).\sigma \\
     R_{2}(t+1)= R_{1}(t).t_{1} + R_{2}(t).(1-m_{2}-t_{2}-\xi)+I_{2}(t).\gamma
   \end{array}
  \right.$$
  Pour la classe d'âge 3 (senior)
  $$\left\{ 
  \begin{array}{ll}
  S_{3}(t+1)= S_{2}(t).t_{2} + S_{3}(t).(1-m_{3}\beta.\frac{\sum_{i=1}^{3}{I_{i}(t)}}{N(t)})+\xi.R_{3}(t) \\
   E_{3}(t+1)= E_{2}(t).t_{2} +  E_{3}(t).(1-m_{3}-\sigma)+S_{3}(t).\beta.\frac{\sum_{i=1}^{3}{I_{i}(t)}}{N(t)} \\
    I_{3}(t+1)= I_{2}(t).t_{2} +  I_{1}(t).(1-m_{3}-\mu-\gamma)+E_{3}(t).\sigma \\
     R_{3}(t+1)= R_{2}(t).t_{2} +  R_{3}(t).(1-m_{3}-\xi)+I_{3}(t).\gamma
   \end{array}
  \right.$$
Avec
$N_{2}(t)=S_{2}(t)+E_{2}(t)+I_{2}(t)+R_{2}(t)$
$N_{3}(t)=S_{3}(t)+E_{3}(t)+I_{3}(t)+R_{3}(t)$
$K$ : capacité de charge du milieu
$SR$ : sex ratio dans la population
$P$ : taille des portées
$m_{i}$ : taux de mortalité naturelle dans la classe d'âge i
$f_{i}$ : taux de fécondité dans la classe d'âge i
$t_{i}$ : taux de passage de la classe d'âge i à la classe d'âge i+1
$\beta$ : taux de transmission de la maladie
$\sigma$ : inverse du temps de latence
$\gamma$ : taux de récupération
$\xi$ : taux de perte d'immunité
$\mu$ : taux de mortalité due à la maladie

  
#### 1.D. Fournissez le schéma des transitions entre états concordant avec ces équations
  
  ![Texte alternatif](image/transition_stade_epidemie.png){width=50%}
  ![Texte alternatif](image/transition_classe_age.png){width=50%}

=> 1 seul schema avec tout
  
#### 1.E. Listez les hypothèses principales de ce modèle (quel type de force d’infection, population variable ou constante, etc)
  
  Dans ce modèle, par rapport à un modèle SIR classique on suppose ...
  
  dynamique des population
  dynamique épidémiologique
  
#### 1.F.
  
  Les conditions initiales du modèle sont :
    27 individus sensibles de classe d'âge 1
    23 individus sensibles de classe d'âge 1
    36 individus sensibles de classe d'âge 3
    1 individus infecté et infectieux de classe d'âge 3
  
#### 1.G.
  
  Les sorties proposés sont :
  
  1- la proportion de malades i.e. infectés (infectieux ou non) à la fin de la période d'étude (deux ans)
  
  2- le nombre d'infection réalisées le dernier jour de la période d'étude
  
  3- le nombre maximum de d'infectés pendant la période d'étude
  
  4- le nombre d'infection réalisés pendant la première année de l'étude
  
  D'autres sorties possibles du modèle peuvent être :
  
  5- la proportion maximale de malades pendant la période d'étude
  
  6- le nombre d'individus sensibles à la fin de la période d'étude
  
#### 1.H.
  
  K : Capacité de l'environnment. Valeur au-dessus de laquelle la population ne produit plus de portée.
  sr : Sex-ratio (proportion de femelles)
  portee : taille des portées
  m_i : mortalité intrasèque spécifique à la classe i
  f_i : fécondité de la classe i
  t_i : probabilité de partir de la classe d'âge i pour rentrer dans la classe i+1
  
  trans : probabilité d'infection (quitter le groupe des sensibles pour devenir infecté/non-infectieux)
  lat : probabilité de devenir contagieux (quitter le groupe des infectés/non-infectieux pour devenir infectés/infectieux)
  rect: probabilité de guérir (quitter le groupe des infectés/infectieux pour devenir guéri/non-sensible)
  loss : probalitité de perte d'immunité (quitter le groupe des guéri/non-sensible pour redevenir sensible)
  
  madd : probabilité de mourir pendant le stade infectés/infectieux
  
#### 1.I.

```{r, warning=FALSE, message=FALSE, echo=FALSE}
ValNominale = c(100, 0.5, 0.0014, 0.00029, 0.0019, 
                0.0019, 0.0082, 5, 1/365, 1/365, 
                0.3, 1/5, 1/20, 1/100, 0.001)


scenario_initial = matrix(ValNominale, nrow=1, ncol=15)

res = modAppli(scenario_initial)

effectif = tibble(
       temps = 1:(2*365),
       S = res[[2]][4,1,],
       L = res[[2]][4,2,],
       I = res[[2]][4,3,],
       R = res[[2]][4,4,],
       N = S + L + I + R)


ggplot() +
  geom_line(data = effectif, aes(x = temps, y = S, color = "1- Susceptible"), linewidth = 1) +
  geom_line(data = effectif, aes(x = temps, y = L, color = "2- Latent"), linewidth = 1) +
  geom_line(data = effectif, aes(x = temps, y = I, color = "3- Infectious"), linewidth = 1) +
  geom_line(data = effectif, aes(x = temps, y = R, color = "4- Recovered"), linewidth = 1) +
  geom_line(data = effectif, aes(x = temps, y = N, color = "Population Size"), linewidth = 1) +
  labs(x = "Time", y = "Population") +
  theme_minimal() +
  ggtitle("Initial Model")

```

  K
#### 2.A Justifiez les valeurs testées

#### 2.B. Fournissez votre script
  
```{r, warning=FALSE, message=FALSE, include=TRUE}
par_name = c("K", "sr", "m1", "m2", "m3", "f2", "f3", "portee", "t1", "t2", "trans", "lat", "rec", "loss", "madd")

ValNominale = c(100, 
                0.5, 0.0014, 0.00029, 0.0019, 
                0.0019, 0.0082, 5, 1/365, 1/365, 
                0.3, 1/5, 1/20, 1/100, 0.001)

scenario_OAT =  matrix(rep(ValNominale, each = 11), nrow = 11, ncol = 15)

graph_oat = function(i, bornes){
  
  scenario_OAT_i = scenario_OAT

  if (bornes[1] != Inf){
    inf = bornes[1]
    sup = bornes[2]
    i=2
    scenario_OAT_i[, i] = c(ValNominale[i],
                          inf + (sup-inf)  * c(0, 0.01, 0.1, 0.3, 0.4, 0.5, 0.7, 0.9, 0.99, 1)
                          )
  }
  else{
    scenario_OAT_i[, i] = ValNominale[i] * c(1,
                                             0, 1/100, 1/10, 1/5, 0.9,
                                             1.1, 2, 5, 10, 100)
  }
    sortie = calculeSortieModele(scenario_OAT_i)
    
    res_plot = tibble(paramettre_i = scenario_OAT_i[, i],
                  prop_inf = sortie[1]/sortie[1,1],
                  infec_end = sortie[2]/sortie[1,2],
                  nb_max_infec = sortie[3]/sortie[1,3] ,
                  nb_infec_year1 = sortie[4]/sortie[1,4])
    
    
    ggplot() +
      geom_line(data = res_plot, aes(x = paramettre_i, y = prop_inf, color = "S1"), size = 1) +
      geom_line(data = res_plot, aes(x = paramettre_i, y = infec_end, color = "S2"), size = 1) +
      geom_line(data = res_plot, aes(x = paramettre_i, y = nb_max_infec,  color = "S3"), size = 1) +
      geom_line(data = res_plot, aes(x = paramettre_i, y = nb_infec_year1,  color = "S4"), size = 1) +
      scale_x_continuous(trans='log10') +
      labs(x = "Parameter value", y = "Relative variation") +
      theme_minimal() +
      ggtitle(par_name[i])
}
```


```{r, warning=FALSE, message=FALSE, fig.dim = c(10, 7)}
ggarrange(graph_oat(i = 1, bornes = c(Inf, Inf)), graph_oat(i = 2, bornes = c(0, 1)), graph_oat(i = 3, bornes = c(0, 1)),
          graph_oat(i = 4, bornes = c(0, 1)), graph_oat(i = 4, bornes = c(0, 1)), graph_oat(i = 5, bornes = c(Inf, Inf)),
          graph_oat(i = 7, bornes = c(Inf, Inf)), graph_oat(i = 8, bornes = c(Inf, Inf)), graph_oat(i = 9, bornes = c(0, 1)),
          graph_oat(i = 10, bornes = c(0,1)), graph_oat(i = 11, bornes = c(0, 1)), graph_oat(i = 12, bornes = c(0, 1)),
          graph_oat(i = 13, bornes = c(0, 1)), graph_oat(i = 14, bornes = c(0, 1)), graph_oat(i = 15, bornes = c(0, 1)),
          ncol = 3, nrow = 5)


```
#### 3.A.

```{r}

par_name = c("K", "sr", "m1", "m2", "m3", "f2", "f3", "portee", "t1", "t2", "trans", "lat", "rec", "loss", "madd")


x <- morris(model = calculeSortieModele, factors = par_name, r = 4, design = list(type = "oat", levels = 6, grid.jump = 3),
            binf=ValNominale*.75,
            bsup=ValNominale*1.25)
print(x)
plot(x)


```

```{r}
parametersName = c("K", "sr", "m1", "m2", "m3", "f2", "f3", "portee", "t1", "t2", "trans", "lat", "rec", "loss", "madd")


entree.calculeSortieModelemorris <- morris(model = NULL, factors = parametersName, r = 10, design = list(type = "oat", levels = 6, grid.jump = 3),
            binf=ValNominale*.75,
            bsup=ValNominale*1.25)

sortie.calculeSortieModelemorris <- calculeSortieModele(entree.calculeSortieModele)

tell(entree.calculeSortieModele, sortie)
print(x)
plot(x)


```


